<apex:page showHeader="false">
   <html>

   <head>

      <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />


      <script src="https://manager.epbx.com.br/Service/scripts/jquery-3.1.0.min.js"></script>
      <script src="https://manager.epbx.com.br/Service/scripts/jquery.signalR.min.js"></script>
      <script src="https://manager.epbx.com.br/Service/signalr/hubs"></script>
      <script src="https://manager.epbx.com.br/salesforce/epbxManagerConfig.js"></script>
      <script src="https://manager.epbx.com.br/salesforce/epbxManagerConnection.js"></script>

      <script type="text/javascript" src="https://c.na172.visual.force.com/support/api/48.0/interaction.js"></script>

      <script type="text/javascript">
         // Callback of API method: setSoftphonePanelHeight
         var setSoftphonePanelHeightCallback = function (response) {
            // Returns true if setSoftphonePanelHeight method is executed successfully, false otherwise
            if (response.result) {
               alert('setSoftphonePanelHeight is successfully executed.');
            }
            else {
               alert('setSoftphonePanelHeight failed.');
            }
         };
         // Invokes API method: setSoftphonePanelHeight
         function setSoftphonePanelHeight() {
            sforce.opencti.setSoftphonePanelHeight({
               heightPX: 500,
               callback: setSoftphonePanelHeightCallback
            });
         }
         // Callback of API method: setSoftphonePanelWidth
         var setSoftphonePanelWidthCallback = function (response) {
            // Returns true if setSoftphonePanelWidth method is executed successfully, false otherwise
            if (response.result) {
               alert('setSoftphonePanelWidth is successfully executed.');
            }
            else {
               alert('setSoftphonePanelWidth failed.');
            }
         };
         // Invokes API method: setSoftphonePanelWidth
         function setSoftphonePanelWidth() {
            sforce.opencti.setSoftphonePanelWidth({
               widthPX: 500,
               callback: setSoftphonePanelHeightCallback
            });
         }
         // Callback of API method: setSoftphoneItemIcon
         var setSoftphoneItemIconCallback = function (response) {
            // Returns true if setSoftphoneItemIcon method is executed successfully, false otherwise
            if (response.result) {
               alert('setSoftphoneItemIcon is successfully executed.');
            }
            else {
               alert('setSoftphoneItemIcon failed.');
            }
         };
         // Invokes API method: setSoftphoneItemIcon
         function setSoftphoneItemIcon() {
            sforce.opencti.setSoftphoneItemIcon({
               key: 'call',
               callback: setSoftphoneItemIconCallback
            });
         }
         // Callback of API method: setSoftphoneItemLabel
         var setSoftphoneItemLabelCallback = function (response) {
            // Returns true if setSoftphoneItemLabel method is executed successfully, false otherwise
            if (response.result) {
               alert('setSoftphoneItemLabel is successfully executed.');
            }
            else {
               alert('setSoftphoneItemLabel failed.');
            }
         };
         // Invokes API method: setSoftphoneItemLabel
         function setSoftphoneItemLabel() {
            sforce.opencti.setSoftphoneItemLabel({
               Label: 'MySoftphone',
               callback: setSoftphoneItemLabelCallback
            });
         }

         var callbackPopUp = function (response) {
            if (response.result) {
              // sforce.interaction.screenPop('/001x0000003DGQR', true, callbackPopUp);
               console.log('API method call executed successfully! returnValue:', response.returnValue);
            } else {
               console.error('Something went wrong! Errors:', response.errors);
            }
         };

         /* Discar */

         var onclickToDial = function (response) {

            var numero = response.result;

            discar(numero);
         };


         function enableClickToDial() {
            sforce.interaction.cti.enableClickToDial();
            sforce.interaction.cti.onClickToDial(onclickToDial);
         }


         var discar = function (numero) {
            if (!numero) {
               showMessage("Número inválido");
               return false;
            }

            var tipoDiscagem = numero.length > 4 ? 1 : 2;

            adapter.server.discar(numero, tipoDiscagem)
               .then(function () {
               })
               .fail(function (err) {
                  showMessage("Erro ao efetuar a discagem");
               });
         }


         var adapter;
         var events;
         var windowHandler;

         /* Eventos Telefonia */
         $(function () {
            console.log("ready!");

            adapter = $.epbxManagerClient;
            events = $.epbxManagerClient.events;
            windowHandler = $(window);

            var chamadaAtual = null;
            var intervaloOptions = {};
            var intervaloAtual = {};

            var panelLogin = $("#panelLogin");
            var panelRamal = $("#panelRamal");
            var statusText = $("#statusText");

            panelRamal.hide();

            windowHandler.on(events.onLogado, function (event, ramal) {
               panelLogin.hide();
               panelRamal.show();
               showMessage("Ramal logado");
               enableClickToDial();
            });

            windowHandler.on(events.onDeslogado, function (event, ramal) {
               panelLogin.show();
               panelRamal.hide();
               showMessage("Ramal Deslogado");
            });

            windowHandler.on(events.onDesliga, function (event, ramal) {
               showMessage("Ligação desligada");
            });

            windowHandler.on(events.onLogadoErro, function (event, ramal, ex) {
               panelLogin.show();
               panelRamal.hide();
               showMessage("Ramal Deslogado");
            });

            windowHandler.on(events.onConexaoErro, function (event, ramal, ex) {
               panelLogin.show();
               panelRamal.hide();
               showMessage("Ramal Deslogado");
            });

            windowHandler.on(events.onSignalrDisconnected, function () {
               panelLogin.show();
               panelRamal.hide();
            });

            windowHandler.on(events.onSetIntervaloRamal, function (event, ramal, intervalo) {

               intervaloAtual = {
                  RamalStatusDetalheId: intervalo.RamalStatusDetalheId
               }
               mostrarIntervaloStatus(intervalo.RamalStatusDetalheId);

               updateIntervalorOptions();
            });

            windowHandler.on(events.onInfoIntervaloRamal, function (event, ramal, infoIntervalo) {

               intervaloOptions[infoIntervalo.RamalStatusDetalheId] = {
                  Descricao: infoIntervalo.Descricao,
                  Produtivo: infoIntervalo.Produtivo
               };


               if (intervaloAtual.RamalStatusDetalheId === infoIntervalo.RamalStatusDetalheId) {
                  mostrarIntervaloStatus(infoIntervalo.RamalStatusDetalheId);
               }

               updateIntervalorOptions();
            });

            windowHandler.on(events.onChamada, function (event, ramal, chamada) {
               showMessage("Evento onChamada");
            });
            windowHandler.on(events.onAtendido, function (event, ramal, chamada) {
               console.log(chamada);

               showMessage("Ligação atendida " + chamada.Telefone);

               var identificador = chamada.CodigoCampanha ? chamada.CodigoCliente : chamada.Telefone;


               sforce.interaction.searchAndScreenPop(identificador, '', 'inbound', callbackPopUp);
               //sforce.interaction.searchAndScreenPop({ searchParams: identificador, queryParams: '', callType: sforce.opencti.CALL_TYPE.INBOUND, deferred: false, callback: callbackPopUp });
            });


            function showMessage(mensagem) {
               statusText.text(mensagem)

            }

            /* Eventos de Tela */
            function loginError(errMessage) {
               showMessage("Erro ao logar ramal");
            }

            function mostrarIntervaloStatus(ramalStatusDetalheId) {
               var intervalo = intervaloOptions[ramalStatusDetalheId];
               if (intervalo) {
                  $("#intervaloStatus").text(intervalo.Descricao);
               }
            }

            function updateIntervalorOptions() {
               var select = $("#intervaloSelect"),
                  value, key, option;

               select.find("option").remove();

               for (key in intervaloOptions) {
                  if (key != intervaloAtual.RamalStatusDetalheId) {
                     value = intervaloOptions[key];
                     option = $("<option></option>")
                        .attr("value", key)
                        .text(key + " - " + value.Descricao);
                     select.append(option);
                  }
               }
            }


            $("#btnLoggin").click(function () {

               var tipoLogon = adapter.TipoLogon.RamalVirtual;
               var idPaOrIpOrRamal = "1009";
               var usuario = $("#txtLogin").val();
               var senha = $("#txtSenha").val();

               if (!usuario) {
                  showMessage("Informe o usuário");
                  return;
               }

               if (!senha) {
                  showMessage("Informe a senha");
                  return;
               }

               adapter.login(usuario, senha, idPaOrIpOrRamal, tipoLogon)
                  .then(adapter.conectarSignalr)
                  .then(adapter.iniciarAtendimento)
                  .fail(loginError);

               return false;
            });


            $("#btnDeslogar").click(function () {
               adapter.server.terminar().then(function () {
                  panelLogin.show();
                  panelRamal.hide();
                  showMessage("Ramal Deslogado");
               }).fail(function () {
                  showMessage("Erro ao deslogar o ramal");
               });
               return false;
            });

            $("#btnDiscar").click(function () {

               var numero = $("#txtNumeroDiscagem").val();

               discar(numero);

               return false;
            });

         });

      </script>
   </head>

   <body>

      <div class="panel panel-default">
         <div class="panel-heading">
            <h3 class="panel-title">EpbxManager</h3>
         </div>
         <div class="panel-body">
            <div class="container-fluid">


               <div class="row">
                  <div style="text-align: center;"><span id="statusText" style="font-size: 14px;"></span></div>
               </div>

               <div id="panelLogin" class="row">
                  <form id="formLogin">
                     <div class="form-group">
                        <label for="usernameInput">Usuário</label>
                        <input type="text" id="txtLogin" class="form-control" value="" />
                     </div>
                     <div class="form-group">
                        <label for="passwordInput">Senha</label>
                        <input type="password" id="txtSenha" class="form-control" value="" />
                     </div>

                     <button type="Button" id="btnLoggin" class="btn btn-success btn-block">Logar</button>
                  </form>
               </div>

               <div id="panelRamal" class="row">
                  <form id="formLogado">

                     <div class="form-group">
                        <button type="Button" id="btnDeslogar" class="btn btn-danger btn-block">Deslogar</button>
                     </div>

                     <div class="form-group">
                        <label for="intervaloSelect">Intervalo</label>
                        <select id="intervaloSelect" class="form-control">
                           <option value="-1">Selecione um intervalo</option>
                        </select>
                     </div>
                     <div class="form-group">
                        <input type="button" value="Alterar" id="btnAlterarIntervalo"
                           class="btn btn-success btn-block" />
                     </div>

                  </form>
                  <form id="formDiscagem">
                     <div class="form-group">
                        <label for="usernameInput">Telefone</label>
                        <input type="text" id="txtNumeroDiscagem" class="form-control" value="" />
                     </div>

                     <button type="Button" id="btnDiscar" class="btn btn-success btn-block">Discar</button>
                  </form>



               </div>


            </div>
         </div>
      </div>



   </body>

   </html>
</apex:page>