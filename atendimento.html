<apex:page showHeader="false" standardStylesheets="false">
   <html>

   <head>
      <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" />

      <script src="https://manager.epbx.com.br/Service/scripts/jquery-3.1.0.min.js"></script>
      <script src="https://manager.epbx.com.br/Service/scripts/jquery.signalR.min.js"></script>
      <script src="https://manager.epbx.com.br/Service/signalr/hubs"></script>
      <script src="https://manager.epbx.com.br/salesforce/epbxManagerConfig.js"></script>
      <script src="https://manager.epbx.com.br/salesforce/epbxManagerConnection.js"></script>

      <script type="text/javascript" src="https://c.na172.visual.force.com/support/api/48.0/interaction.js"></script>

      <script type="text/javascript">
         // Callback of API method: setSoftphonePanelHeight
         var setSoftphonePanelHeightCallback = function (response) {
            // Returns true if setSoftphonePanelHeight method is executed successfully, false otherwise
            if (response.result) {
               alert('setSoftphonePanelHeight is successfully executed.');
            }
            else {
               alert('setSoftphonePanelHeight failed.');
            }
         };
         // Invokes API method: setSoftphonePanelHeight
         function setSoftphonePanelHeight() {
            sforce.opencti.setSoftphonePanelHeight({
               heightPX: 500,
               callback: setSoftphonePanelHeightCallback
            });
         }
         // Callback of API method: setSoftphonePanelWidth
         var setSoftphonePanelWidthCallback = function (response) {
            // Returns true if setSoftphonePanelWidth method is executed successfully, false otherwise
            if (response.result) {
               alert('setSoftphonePanelWidth is successfully executed.');
            }
            else {
               alert('setSoftphonePanelWidth failed.');
            }
         };
         // Invokes API method: setSoftphonePanelWidth
         function setSoftphonePanelWidth() {
            sforce.opencti.setSoftphonePanelWidth({
               widthPX: 500,
               callback: setSoftphonePanelHeightCallback
            });
         }
         // Callback of API method: setSoftphoneItemIcon
         var setSoftphoneItemIconCallback = function (response) {
            // Returns true if setSoftphoneItemIcon method is executed successfully, false otherwise
            if (response.result) {
               alert('setSoftphoneItemIcon is successfully executed.');
            }
            else {
               alert('setSoftphoneItemIcon failed.');
            }
         };
         // Invokes API method: setSoftphoneItemIcon
         function setSoftphoneItemIcon() {
            sforce.opencti.setSoftphoneItemIcon({
               key: 'call',
               callback: setSoftphoneItemIconCallback
            });
         }
         // Callback of API method: setSoftphoneItemLabel
         var setSoftphoneItemLabelCallback = function (response) {
            // Returns true if setSoftphoneItemLabel method is executed successfully, false otherwise
            if (response.result) {
               alert('setSoftphoneItemLabel is successfully executed.');
            }
            else {
               alert('setSoftphoneItemLabel failed.');
            }
         };
         // Invokes API method: setSoftphoneItemLabel
         function setSoftphoneItemLabel() {
            sforce.opencti.setSoftphoneItemLabel({
               Label: 'MySoftphone',
               callback: setSoftphoneItemLabelCallback
            });
         }



         /* Discar */


         var adapter;
         var events;
         var windowHandler;

         var chamadaAtual = null;
         var intervaloOptions = {};
         var intervaloAtual = {};

         /* Controle de Tela */
         var statusText;
         var panelLogin;
         var panelRamal

         var callbackPopUp = function (response) {
            if (response.result) {
               console.log('API method call executed successfully! returnValue:', response.returnValue);
            } else {
               console.error('Something went wrong! Errors:', response.errors);
            }
         }

         var onclickToDial = function (response) {

            var obj  = JSON.parse(response.result);

            var numero = obj.numero;

            discar(numero);
         }

         var enableClickToDial = function () {
            sforce.interaction.cti.enableClickToDial();
            sforce.interaction.cti.onClickToDial(onclickToDial);
         }

         var showMessage = function (mensagem) {
            statusText.text(mensagem)
         }

         var loginError = function (errMessage) {
            showMessage("Erro ao logar ramal");
         }

         var mostrarIntervaloStatus = function (ramalStatusDetalheId) {
            var intervalo = intervaloOptions[ramalStatusDetalheId];
            if (intervalo) {
               $("#intervaloStatus").text(intervalo.Descricao);
            }
         }

         var discar = function (numero) {
            if (!numero) {
               showMessage("Número inválido");
               return false;
            }

            showMessage("Discando " + numero);

            var tipoDiscagem = numero.length > 4 ? 1 : 2;

            adapter.server.discar(numero, tipoDiscagem)
               .then(function () {
                  btnDesligar.show();
                  btnDiscar.hide()
               })
               .fail(function (err) {
                  showMessage("Erro ao efetuar a discagem");
                  btnDesligar.hide();
                  btnDiscar.show()
               });
         }

         var updateIntervalorOptions = function () {
            var select = $("#intervaloSelect"),
               value, key, option;

            select.find("option").remove();

            for (key in intervaloOptions) {
               value = intervaloOptions[key];
               if (intervaloAtual.RamalStatusDetalheId != value) {
                  option = $("<option></option>")
                     .attr("value", key)
                     .text(key + " - " + value.Descricao);
                  select.append(option);
               }
            }

            /* var intervalo = intervaloOptions[intervaloAtual.RamalStatusDetalheId];
             if (intervalo) {
                $("#intervaloStatus").text(intervalo.Descricao);
             }
             */


            select.val(intervaloAtual.RamalStatusDetalheId);
         }


         /* Eventos Telefonia */
         $(function () {
            console.log("ready!");

            adapter = $.epbxManagerClient;
            events = $.epbxManagerClient.events;
            windowHandler = $(window);

            chamadaAtual = null;
            intervaloOptions = {};
            intervaloAtual = {};

            panelLogin = $("#panelLogin");
            panelRamal = $("#panelRamal");
            statusText = $("#statusText");
            btnDeslogar = $("#btnDeslogar");
            btnDiscar = $("#btnDiscar");
            btnDesligar = $("#btnDesligar");

            panelRamal.hide();
            btnDeslogar.hide();
            btnDesligar.hide();
            btnDiscar.show()

            windowHandler.on(events.onLogado, function (event, ramal) {
               panelLogin.hide();
               panelRamal.show();
               showMessage("Ramal logado");
               enableClickToDial();
               btnDeslogar.show()
            });

            windowHandler.on(events.onDeslogado, function (event, ramal) {
               panelLogin.show();
               panelRamal.hide();
               btnDeslogar.hide();
               btnDesligar.hide();
               btnDiscar.show()
               showMessage("Ramal Deslogado");
            });

            windowHandler.on(events.onDesliga, function (event, ramal) {
               showMessage("Ligação desligada");
               btnDesligar.hide();
               btnDiscar.show()
            });

            windowHandler.on(events.onLogadoErro, function (event, ramal, ex) {
               panelLogin.show();
               panelRamal.hide();
               btnDeslogar.hide()
               showMessage("Ramal Deslogado");
            });

            windowHandler.on(events.onConexaoErro, function (event, ramal, ex) {
               panelLogin.show();
               panelRamal.hide();
               btnDeslogar.hide()
               showMessage("Ramal Deslogado");
            });

            windowHandler.on(events.onSignalrDisconnected, function () {
               panelLogin.show();
               panelRamal.hide();
               btnDeslogar.hide()
            });

            windowHandler.on(events.onSetIntervaloRamal, function (event, ramal, intervalo) {

               //Intervalo Pendente
               if (intervalo.Status == 1) return;

               intervaloAtual = {
                  RamalStatusDetalheId: intervalo.RamalStatusDetalheId
               }

               updateIntervalorOptions();
            });

            windowHandler.on(events.onInfoIntervaloRamal, function (event, ramal, infoIntervalo) {

               intervaloOptions[infoIntervalo.RamalStatusDetalheId] = {
                  Descricao: infoIntervalo.Descricao,
                  Produtivo: infoIntervalo.Produtivo
               };

               updateIntervalorOptions();
            });

            windowHandler.on(events.onChamada, function (event, ramal, chamada) {
               showMessage("Evento onChamada");
            });

            windowHandler.on(events.onAtendido, function (event, ramal, chamada) {
               console.log(chamada);

               btnDesligar.show();
               btnDiscar.hide();

               showMessage("Ligação atendida " + chamada.Telefone);

               var identificador = chamada.CodigoCampanha ? chamada.CodigoCliente : chamada.Telefone;

               sforce.interaction.searchAndScreenPop(identificador, '', 'inbound', callbackPopUp);
            });

            /* Eventos de Tela */

            $("#btnLoggin").click(function () {

               var tipoLogon = adapter.TipoLogon.RamalVirtual;
               var idPaOrIpOrRamal = "1009";
               var usuario = $("#txtLogin").val();
               var senha = $("#txtSenha").val();

               if (!usuario) {
                  showMessage("Informe o usuário");
                  return;
               }

               if (!senha) {
                  showMessage("Informe a senha");
                  return;
               }

               adapter.login(usuario, senha, idPaOrIpOrRamal, tipoLogon)
                  .then(adapter.conectarSignalr)
                  .then(adapter.iniciarAtendimento)
                  .fail(loginError);

               return false;
            });

            $("#btnDeslogar").click(function () {
               adapter.server.terminar().then(function () {
                  panelLogin.show();
                  panelRamal.hide();
                  btnDeslogar.hide();
                  showMessage("Ramal Deslogado");
               }).fail(function () {
                  showMessage("Erro ao deslogar o ramal");
               });
               return false;
            });

            $("#btnDiscar").click(function () {

               var numero = $("#txtNumeroDiscagem").val();

               discar(numero);

               return false;
            });

            $("#btnDesligar").click(function () {

               adapter.server.desligar().fail(function () {
                  showMessage("Erro ao desligar ligação");
               });

               return false;
            });

            $("#intervaloSelect").change(function () {

               let intervalo = $(this).val();

               console.log("intervalo " + intervalo);

               adapter.server.alterarIntervaloTipo(intervalo).fail(function () {
                  showMessage("Erro ao alterar intervalo");
               });
            })


         });

      </script>
   </head>

   <body>

      <div class="panel panel-default">
         <div class="panel-heading">
            <img src="http://manager.epbx.com.br/assets/img/logo.png" height="30" />
            <button style="float: right;" type="Button" id="btnDeslogar" class="btn btn-danger btn-sm">Deslogar</button>
         </div>
         <div class="panel-body">
            <div class="container-fluid">
               <div class="row">
                  <div style="text-align: center;"><span id="statusText" style="font-size: 14px;"></span></div>

               </div>

               <div id="panelLogin" class="row">
                  <form id="formLogin">
                     <div class="form-group">
                        <label for="usernameInput">Usuário</label>
                        <input type="text" id="txtLogin" class="form-control" value="" />
                     </div>
                     <div class="form-group">
                        <label for="passwordInput">Senha</label>
                        <input type="password" id="txtSenha" class="form-control" value="" />
                     </div>
                     <button type="Button" id="btnLoggin" class="btn btn-success btn-block">Logar</button>
                  </form>
               </div>

               <div id="panelRamal" class="row">
                  <form id="formLogado">

                     <div class="form-group">
                        <label for="intervaloSelect">Intervalo</label>
                        <select id="intervaloSelect" class="form-control">
                           <option value="-1">Selecione um intervalo</option>
                        </select>
                     </div>
                  </form>
                  <form id="formDiscagem">
                     <div class="form-group">
                        <label for="usernameInput">Telefone</label>
                        <input type="text" id="txtNumeroDiscagem" class="form-control" value="" />
                     </div>

                     <button type="Button" id="btnDiscar" class="btn btn-success btn-block">Discar</button>
                     <button type="Button" id="btnDesligar" class="btn btn-danger btn-block">Desligar</button>
                  </form>
               </div>
            </div>
         </div>
      </div>
   </body>

   </html>
</apex:page>